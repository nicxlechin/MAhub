<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarTech Automation Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
        .typing-indicator span {
            animation: typing 1.4s infinite;
            animation-fill-mode: both;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="text-white p-6">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                MarTech Automation Hub
            </h1>
            <p class="text-slate-300">Ask anything about your marketing technology stack</p>
        </div>

        <!-- Search Bar -->
        <div class="mb-6 relative">
            <input type="text" id="searchInput" placeholder="Ask a question... (e.g., 'How do I send a push notification?')"
                class="w-full px-6 py-4 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-400 pr-24"
                onkeypress="if(event.key==='Enter')runQuery()">
            <button onclick="runQuery()" class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-purple-500 hover:bg-purple-600 px-5 py-2 rounded-lg">
                Ask
            </button>
        </div>

        <!-- Quick Questions -->
        <div class="mb-8">
            <h3 class="text-sm font-semibold text-slate-400 mb-3 uppercase tracking-wide">Popular Questions</h3>
            <div class="flex flex-wrap gap-2">
                <button onclick="runQuery('How does lead scoring work?')" class="bg-slate-800/50 hover:bg-slate-700 border border-slate-700 rounded-full px-4 py-2 text-sm">
                    How does lead scoring work?
                </button>
                <button onclick="runQuery('What is predictive churn?')" class="bg-slate-800/50 hover:bg-slate-700 border border-slate-700 rounded-full px-4 py-2 text-sm">
                    What is predictive churn?
                </button>
                <button onclick="runQuery('How is user data collected?')" class="bg-slate-800/50 hover:bg-slate-700 border border-slate-700 rounded-full px-4 py-2 text-sm">
                    How is data collected?
                </button>
                <button onclick="runQuery('What channels does Braze support?')" class="bg-slate-800/50 hover:bg-slate-700 border border-slate-700 rounded-full px-4 py-2 text-sm">
                    Braze channels
                </button>
                <button onclick="runQuery('What is the difference between MTA and MMM?')" class="bg-slate-800/50 hover:bg-slate-700 border border-slate-700 rounded-full px-4 py-2 text-sm">
                    MTA vs MMM
                </button>
                <button onclick="runQuery('GDPR compliance requirements')" class="bg-slate-800/50 hover:bg-slate-700 border border-slate-700 rounded-full px-4 py-2 text-sm">
                    GDPR compliance
                </button>
                <button onclick="runQuery('List all Braze campaigns')" class="bg-slate-800/50 hover:bg-slate-700 border border-slate-700 rounded-full px-4 py-2 text-sm">
                    List Braze campaigns
                </button>
            </div>
        </div>

        <!-- Results Area -->
        <div id="resultsArea" class="space-y-4">
            <!-- Welcome message -->
            <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-6">
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-lg">ðŸ¤–</span>
                    </div>
                    <div>
                        <p class="text-slate-300">Hi! I'm your Mindvalley MarTech assistant. I can help you with:</p>
                        <ul class="mt-2 text-slate-400 text-sm space-y-1">
                            <li>â€¢ Your stack: Segment, Braze, Amplitude, Mixpanel, AppsFlyer, Clarisights</li>
                            <li>â€¢ Data flows, audiences, and computed traits</li>
                            <li>â€¢ Lead scoring, predictive LTV, churn models</li>
                            <li>â€¢ Campaigns, canvases, and segmentation</li>
                            <li>â€¢ Attribution (MTA/MMM) and measurement</li>
                            <li>â€¢ Compliance (GDPR, CPRA, consent)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden bg-slate-800/50 border border-slate-700 rounded-xl p-6 mt-4">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-lg">ðŸ¤–</span>
                </div>
                <div class="typing-indicator flex gap-1">
                    <span class="w-2 h-2 bg-purple-400 rounded-full"></span>
                    <span class="w-2 h-2 bg-purple-400 rounded-full"></span>
                    <span class="w-2 h-2 bg-purple-400 rounded-full"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PROXY_URL = 'https://ma-hub.vercel.app';

        // Load admin-configured Braze settings (stored by admin)
        const brazeConfig = JSON.parse(localStorage.getItem('brazeConfig') || '{}');

        async function runQuery(presetQuery) {
            const query = presetQuery || document.getElementById('searchInput').value.trim();
            if (!query) return;

            document.getElementById('searchInput').value = '';
            showLoading(true);

            // Add user message
            addMessage('user', query);

            // Check if this is a Braze data request
            const isBrazeQuery = /braze|campaign|canvas|segment/i.test(query) &&
                                 /list|show|get|fetch|all/i.test(query);

            try {
                let response = '';

                if (isBrazeQuery && brazeConfig.apiKey) {
                    // Fetch from Braze API
                    const brazeRes = await fetch(`${PROXY_URL}/api/braze-campaigns`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey: brazeConfig.apiKey,
                            restEndpoint: brazeConfig.restEndpoint,
                            page: 0
                        })
                    });
                    const brazeData = await brazeRes.json();

                    if (brazeData.campaigns && brazeData.campaigns.length > 0) {
                        const sortedCampaigns = [...brazeData.campaigns].sort((a, b) => {
                            const dateA = new Date(a.last_edited || a.created_at);
                            const dateB = new Date(b.last_edited || b.created_at);
                            return dateB - dateA;
                        });

                        response = `Found **${sortedCampaigns.length} campaigns** in Braze:\n\n`;
                        sortedCampaigns.slice(0, 10).forEach((c, i) => {
                            const date = new Date(c.last_edited || c.created_at);
                            response += `${i + 1}. **${c.name}**\n   Last edited: ${date.toLocaleString()}\n\n`;
                        });
                        if (sortedCampaigns.length > 10) {
                            response += `\n_...and ${sortedCampaigns.length - 10} more campaigns_`;
                        }
                    } else {
                        response = 'No campaigns found in Braze, or Braze connection not configured by admin.';
                    }
                } else {
                    // Search knowledge base
                    const kbRes = await fetch(`${PROXY_URL}/api/knowledge`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query })
                    });
                    const kbData = await kbRes.json();

                    if (kbData.success && kbData.totalResults > 0) {
                        response = formatKBResponse(query, kbData.results);
                    } else {
                        response = `I couldn't find specific information about "${query}" in the knowledge base. Try asking about:\n\nâ€¢ Specific tools (Braze, Segment, Amplitude)\nâ€¢ Data flows and integrations\nâ€¢ How to perform common tasks`;
                    }
                }

                showLoading(false);
                addMessage('assistant', response);

            } catch (error) {
                showLoading(false);
                addMessage('assistant', `Sorry, I encountered an error: ${error.message}. Please try again.`);
            }
        }

        function formatKBResponse(query, results) {
            let response = '';

            // Check for FAQ matches first (highest priority)
            if (results.faqs && results.faqs.length > 0) {
                const faq = results.faqs[0];
                response += `**${faq.question}**\n\n${faq.answer}\n\n`;
            }

            // Add tool information
            if (results.tools && results.tools.length > 0) {
                if (!results.faqs || results.faqs.length === 0) {
                    response += `Here's what I found:\n\n`;
                }

                results.tools.slice(0, 3).forEach(tool => {
                    const statusBadge = tool.status === 'deprecated' ? ' _(being migrated)_' : '';
                    response += `**${tool.tool}**${statusBadge} (${tool.category})\n`;
                    response += `${tool.description}\n\n`;

                    if (tool.capabilities && tool.capabilities.length > 0) {
                        response += `Key capabilities:\n`;
                        tool.capabilities.slice(0, 6).forEach(cap => {
                            response += `â€¢ ${cap}\n`;
                        });
                        response += '\n';
                    }

                    if (tool.channels && tool.channels.length > 0) {
                        response += `Channels: ${tool.channels.join(', ')}\n\n`;
                    }

                    if (tool.integrations && tool.integrations.length > 0) {
                        response += `Integrates with: ${tool.integrations.join(', ')}\n\n`;
                    }

                    if (tool.consolidationPlan) {
                        response += `**Migration plan:** ${tool.consolidationPlan.movingToBraze.join(', ')} â†’ Braze\n\n`;
                    }
                });
            }

            // Add predictive models
            if (results.predictiveModels && results.predictiveModels.length > 0) {
                response += `**Predictive Models:**\n\n`;
                results.predictiveModels.forEach(model => {
                    response += `**${model.name}** ${model.scale ? `(${model.scale})` : ''}\n`;
                    response += `${model.description}\n`;
                    if (model.tiers) {
                        model.tiers.forEach(tier => {
                            const label = tier.label ? ` (${tier.label})` : '';
                            response += `â€¢ ${tier.tier}${label}: ${tier.action}\n`;
                        });
                    }
                    response += '\n';
                });
            }

            // Add strategic pillars
            if (results.strategicPillars && results.strategicPillars.length > 0) {
                response += `**Strategic Pillars:**\n\n`;
                results.strategicPillars.forEach(pillar => {
                    response += `**${pillar.name}**: ${pillar.description}\n`;
                    pillar.initiatives.slice(0, 3).forEach(init => {
                        response += `â€¢ ${init}\n`;
                    });
                    response += '\n';
                });
            }

            // Add data flow information
            if (results.dataFlows && results.dataFlows.length > 0) {
                response += `**Data Flows:**\n`;
                results.dataFlows.forEach(flow => {
                    response += `â€¢ **${flow.name}**: ${flow.source} â†’ ${flow.destination}\n`;
                    response += `  _${flow.description}_\n`;
                    response += `  Data: ${flow.dataType}\n`;
                });
                response += '\n';
            }

            // Add measurement framework
            if (results.measurementFramework) {
                response += `**Measurement Framework:**\n`;
                response += `_${results.measurementFramework.description}_\n\n`;
                results.measurementFramework.approaches.forEach(approach => {
                    response += `â€¢ **${approach.name}** - ${approach.purpose}\n`;
                    response += `  ${approach.description}\n`;
                });
                response += '\n';
            }

            // Add compliance info
            if (results.compliance && results.compliance.length > 0) {
                const comp = results.compliance[0];
                response += `**Compliance & Privacy:**\n`;
                response += `Regulations: ${comp.regulations.join(', ')}\n\n`;
                response += `_"${comp.principle}"_\n\n`;
                comp.highRiskAreas.forEach(area => {
                    response += `**${area.area}:**\n`;
                    area.requirements.forEach(req => {
                        response += `â€¢ ${req}\n`;
                    });
                });
            }

            return response || `I couldn't find specific information about "${query}". Try asking about:\n\nâ€¢ Tools (Braze, Segment, Amplitude, AppsFlyer)\nâ€¢ Data flows and integrations\nâ€¢ Lead scoring, LTV, or churn prediction\nâ€¢ Compliance and consent\nâ€¢ Strategic pillars`;
        }

        function addMessage(role, content) {
            const resultsArea = document.getElementById('resultsArea');

            const messageDiv = document.createElement('div');
            messageDiv.className = 'bg-slate-800/50 border border-slate-700 rounded-xl p-6';

            const isUser = role === 'user';
            const avatar = isUser ? 'ðŸ‘¤' : 'ðŸ¤–';
            const bgGradient = isUser ? 'from-slate-500 to-slate-600' : 'from-purple-500 to-pink-500';

            // Convert markdown-like formatting to HTML
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');

            messageDiv.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 bg-gradient-to-br ${bgGradient} rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-lg">${avatar}</span>
                    </div>
                    <div class="flex-1 text-slate-300 leading-relaxed">
                        ${formattedContent}
                    </div>
                </div>
            `;

            resultsArea.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
